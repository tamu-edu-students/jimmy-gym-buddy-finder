<h1>Chat with <%= @other_user.username %></h1>

<div id="messages" data-conversation-id="<%= @conversation.id %>">
  <%= render @messages %>
</div>

<%= form_with(model: [@conversation, @message], local: false, id: 'new-message-form') do |f| %>
  <%= f.text_field :content, placeholder: 'Type your message...', required: true %>
  <%= f.submit 'Send' %>
<% end %>

<script>
document.addEventListener('turbo:load', () => {
  const form = document.getElementById('new-message-form');
  form.addEventListener('submit', (event) => {
    event.preventDefault();
    const formData = new FormData(form);
    fetch(form.action, {
      method: 'POST',
      body: formData,
      headers: {
        'X-CSRF-Token': document.querySelector("meta[name='csrf-token']").content,
        'Accept': 'application/json'
      }
    }).then(response => {
      if (response.ok) {
        form.reset();
      } else {
        console.error('Error sending message');
      }
    });
  });
});
</script>