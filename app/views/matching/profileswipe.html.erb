<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <%= csrf_meta_tags %>
  <title>Profile Swipe</title>
  
  <%= javascript_include_tag 'application', 'data-turbolinks-track': 'reload' %>
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <%= stylesheet_link_tag 'application', media: 'all', 'data-turbolinks-track': 'reload' %>
</head>
<body>
  <div class="container d-flex flex-column align-items-center mt-4">
    <!-- Search Filter -->
    <div class="w-100 mb-3 d-flex justify-content-center">
      <input type="text" id="search" class="form-control" style="width: 400px;" placeholder="Search Profiles" onkeyup="filterProfiles()" />
    </div>
    <!-- Tinder-like Cards -->
    <div class="profile-cards w-100 d-flex flex-column align-items-center">
      <% @prospective_users.each_with_index do |user, index| %>
        <div class="profile-card card shadow mb-2" style="display:<%= index == 0 ? 'block' : 'none' %>;" data-user-id="<%= user['id'] %>">
        <% if user['photo'].present? %>
          <%= image_tag user['photo'], class: "card-img-top", alt: user['username'] %>
        <% else %>
          <%= image_tag 'https://www.shutterstock.com/image-vector/default-avatar-profile-icon-social-600nw-1677509740.jpg', class: "card-img-top", alt: user['username'] %>
        <% end %>
          <div class="card-body text-center">
            <h5 class="card-title"><%= user['username'] %></h5>
            <p class="card-text">Age: <%= user['age'] %></p>
            <p class="card-text">Activities: <%= user['fitness_profile']['activities_with_experience'].split('|').map { |a| a.split(':').first }.join(', ') %></p>
          </div>
        </div>
      <% end %>
    </div>

    <!-- Action Buttons -->
    <div class="row justify-content-center mt-2 w-100">
      <div class="col-auto">
        <button class="btn btn-warning" onclick="handleAction('block')" title="Block">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="col-auto">
        <button class="btn btn-warning" onclick="handleAction('skip')" title="Skip">
          <i class="fas fa-ban"></i>
        </button>
      </div>
      <div class="col-auto">
        <button class="btn btn-warning" onclick="handleAction('like')" title="Like">
          <i class="fas fa-thumbs-up"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- JavaScript for profile swipe functionality -->
  <script>
    document.addEventListener("turbo:load", function () {
      let currentCardIndex = 0;
      const cards = document.querySelectorAll(".profile-card");

      function initializeCards() {
        cards.forEach((card, index) => {
          card.style.display = index === 0 ? "block" : "none";
        });
      }

      initializeCards();

      function animateCard(action) {
        const card = cards[currentCardIndex];
        if (!card) return;

        card.classList.add(`animate-${action}`);
        
        setTimeout(() => {
          card.classList.remove(`animate-${action}`);
          card.style.display = "none";

          // Move to next card
          currentCardIndex = (currentCardIndex + 1) % cards.length;
          const nextCard = cards[currentCardIndex];
          if (nextCard) nextCard.style.display = "block";
        }, 500); // Time to match CSS transition duration
      }

      window.handleAction = function (action) {
        const card = cards[currentCardIndex];
        const userId = <%= @user_id %>;
        const prospectiveUserId = card.dataset.userId;

        let url;
        let method;

        switch (action) {
          case 'like':
            url = `/users/${userId}/match/${prospectiveUserId}`;
            method = 'GET';
            break;
          case 'skip':
            url = `/users/${userId}/skip/${prospectiveUserId}`;
            method = 'POST';
            break;
          case 'block':
            url = `/users/${userId}/block/${prospectiveUserId}`;
            method = 'POST';
            break;
        }

        fetch(url, { 
          method: method, 
          headers: { 
            'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content,
            'Content-Type': 'application/json'
          }
        })
          .then(response => response.json())
          .then(data => {
            console.log(data.message);
            animateCard(action);
          })
          .catch(error => console.error('Error:', error));
      };

      window.filterProfiles = function () {
        const searchTerm = document.getElementById("search").value.toLowerCase();
        let found = false;

        cards.forEach((card, index) => {
          const profileText = card.innerText.toLowerCase();
          if (profileText.includes(searchTerm)) {
            if (!found) {
              currentCardIndex = index;
              card.style.display = "block";
              found = true;
            } else {
              card.style.display = "none";
            }
          } else {
            card.style.display = "none";
          }
        });

        if (!found) currentCardIndex = -1;
      };
    });
  </script>

  <!-- Bootstrap JS and dependencies -->
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@1.16.0/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

  <style>
    .profile-cards {
      max-width: 400px;
      width: 100%;
      margin: 0 auto;
    }

    .profile-card {
      border-radius: 10px;
      overflow: hidden;
      width: 100%;
      max-height: 350px;
      transition: transform 0.5s ease, opacity 0.5s ease;
    }

    .profile-card.animate-like {
      transform: translateX(100%);
      opacity: 0;
    }

    .profile-card.animate-skip {
      transform: translateX(-100%);
      opacity: 0;
    }

    .profile-card.animate-block {
      transform: translateX(-100%);
      opacity: 0;
    }

    .card-title, .card-text {
      margin-bottom: 5px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    
      .profile-card {
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  border-radius: 10px;
  overflow: hidden;
  width: 100%;
  max-height: 350px;
  height: 350px; /* Set fixed height for consistent layout */
  transition: transform 0.5s ease, opacity 0.5s ease;
}

.profile-card img {
  height: 70%; /* Image takes 80% of the card */
  width: 100%;
  
  margin: 0;
  padding:0;
  object-fit: fill;
}

.card-body {
  height: 30%; /* Card body takes 20% */
  padding: 10px;
  display: flex;
  flex-direction: column;
  justify-content: center;
  text-align: center;
}

  </style>
</body>
</html>
